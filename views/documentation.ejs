<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel='stylesheet' href='/stylesheets/style.css' />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
</head>
<body>
  <div class="container">
    <a href="/" class="btn-back">‚Üê Back to Home</a>
    <h1><%= title %></h1>
    <p>Documentation generated for databases on page: <strong><%= pageId %></strong></p>

    <% databases.forEach(db => { %>
      <div class="database-section" style="overflow-x: scroll;">
        <h2>Database: <%= db.title %></h2>
        <% if (db.description) { %>
          <p class="database-description"><%= db.description %></p>
        <% } %>
        
        <h3>Properties & Schema</h3>
        <table class="properties-table">
          <thead>
            <tr>
              <th>Property Name</th>
              <th>Type</th>
              <th>Dependencies & Relations</th>
              <th>Used By</th>
              <th>Can be Empty</th>
              <th>Notes (Template)</th>
            </tr>
          </thead>
          <tbody>
            <% db.properties.forEach(prop => { %>
              <tr>
                <td><%= prop.name %></td>
                <td><span class="property-type property-type-<%= prop.type %>"><%= prop.type %></span></td>
                <td class="dependencies-cell" style="overflow-x: scroll;max-width: 200px;">
                  <% if (prop.type === 'formula') { %>
                    <div class="formula-details">
                      <div class="formula-header">
                        <strong>Formula:</strong>
                        <button class="btn-expand" title="Expand Code">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M9 3H3v6h1.5V4.5H9V3zm6 0v1.5h4.5V9H21V3h-6zM9 21v-1.5H4.5V15H3v6h6zm6 0h6v-6h-1.5v4.5H15V21z"></path></svg>
                        </button>
                      </div>
                      <pre style="width: max-content;padding-right: 1rem;"><code style="max-width: fit-content;" class="language-javascript"><%= prop.formula %></code></pre>

                      <% if (prop.dependencies.length > 0) { %>
                        <strong>Depends on:</strong>
                        <ul>
                          <% prop.dependencies.forEach(dep => { %>
                            <li><%= dep %></li>
                          <% }); %>
                        </ul>
                      <% } %>
                    </div>
                  <% } else if (prop.type === 'relation' && prop.relation) { %>
                    <div class="relation-details">
                      <strong>Relation to:</strong> 
                      <span class="db-relation"><%= prop.relation.database_title || prop.relation.database_id %></span>
                    </div>
                  <% } else if (prop.type === 'rollup' && prop.rollup) { %>
                    <div class="rollup-details">
                      <div><strong>Rollup via:</strong> <span class="relation-prop"><%= prop.rollup.relation_property_name %></span></div>
                      <div><strong>Of Property:</strong> <span class="rollup-prop"><%= prop.rollup.rollup_property_name %></span></div>
                      <div><strong>Using:</strong> <span class="rollup-func"><%= prop.rollup.function %></span></div>
                    </div>
                  <% } else { %>
                    <span class="not-applicable">N/A</span>
                  <% } %>
                </td>
                <td class="used-by-cell">
                  <% if (prop.usedBy && prop.usedBy.length > 0) { %>
                    <ul>
                      <% prop.usedBy.forEach(user => { %>
                        <li><%= user %></li>
                      <% }); %>
                    </ul>
                  <% } else { %>
                    <span class="not-applicable">N/A</span>
                  <% } %>
                </td>
                <td>
                  <select class="can-be-empty-select">
                    <option value="true">True</option>
                    <option value="false" selected>False</option>
                  </select>
                </td>
                <td>
                  <textarea class="notes-template" placeholder="Add your notes here..."></textarea>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    <% }); %>
  </div>

  <div id="code-modal" class="modal-hidden">
    <div class="modal-content">
      <span class="modal-close-btn">&times;</span>
      <pre><code id="modal-code" class="language-javascript"></code></pre>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    // Initialize Highlight.js for all code blocks on page load
    hljs.highlightAll();

    // --- Modal Logic ---
    const modal = document.getElementById('code-modal');
    const modalCodeElement = document.getElementById('modal-code');
    const closeModalBtn = document.querySelector('.modal-close-btn');

    // Add event listener to all "Expand" buttons
    document.querySelectorAll('.btn-expand').forEach(button => {
      button.addEventListener('click', function() {
        // Get the already-highlighted HTML from the source code block
        const originalCodeHTML = this.closest('.formula-details').querySelector('pre code').innerHTML;
        
        // Set the innerHTML of the modal code block to preserve the highlighting
        modalCodeElement.innerHTML = originalCodeHTML;
        
        // Show the modal
        modal.classList.remove('modal-hidden');
      });
    });

    // Function to close the modal
    function closeModal() {
      modal.classList.add('modal-hidden');
    }

    // Close modal when the close button is clicked
    closeModalBtn.addEventListener('click', closeModal);

    // Close modal when clicking on the background overlay
    modal.addEventListener('click', function(event) {
      if (event.target === modal) {
        closeModal();
      }
    });
  </script>
</body>
</html>
